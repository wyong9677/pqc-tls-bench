name: pqc-bench

on:
  workflow_dispatch:

jobs:
  bench:
    runs-on: ubuntu-latest
    env:
      # 先用 latest 跑通；跑通后改为 digest 固定复现
      IMG: openquantumsafe/oqs-ossl3:latest

      # 基准参数（统一控制）
      TIMESEC: "15"        # throughput s_time 持续秒数
      N: "50"              # latency 采样次数
      BENCH_SECONDS: "5"   # openssl speed seconds（不要用 SECONDS）

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare output files
        run: |
          : > env_info.txt
          : > tls_bench.txt
          : > tls_latency.txt
          : > sig_bench.txt
          echo "Prepared placeholder files." | tee -a env_info.txt

      - name: Debug repo layout
        run: |
          echo "=== PWD ===" | tee -a env_info.txt
          pwd | tee -a env_info.txt
          echo "=== repo root ===" | tee -a env_info.txt
          ls -la | tee -a env_info.txt
          echo "=== scripts dir ===" | tee -a env_info.txt
          ls -la scripts | tee -a env_info.txt || true

      - name: Pull OQS image
        timeout-minutes: 5
        run: |
          echo "Pulling ${IMG}" | tee -a env_info.txt
          docker pull "${IMG}" 2>&1 | tee -a env_info.txt

      - name: Probe OPENSSL_BIN in container
        timeout-minutes: 2
        run: |
          echo "=== Probe OPENSSL_BIN ===" | tee -a env_info.txt
          echo "IMG=${IMG}" | tee -a env_info.txt

          OPENSSL_BIN="$(docker run --rm "${IMG}" sh -lc '
            for p in \
              /usr/local/bin/openssl \
              /usr/bin/openssl \
              /opt/openssl/bin/openssl \
              /opt/oqs/bin/openssl \
              /opt/local/bin/openssl \
              /usr/local/ssl/bin/openssl
            do
              if [ -x "$p" ]; then
                echo "$p"
                exit 0
              fi
            done
            if command -v openssl >/dev/null 2>&1; then
              echo openssl
              exit 0
            fi
            exit 1
          ' 2>/dev/null || true)"

          if [ -z "${OPENSSL_BIN}" ]; then
            echo "ERROR: cannot find openssl in container (OPENSSL_BIN is empty)" | tee -a env_info.txt
            exit 1
          fi

          echo "OPENSSL_BIN=${OPENSSL_BIN}" | tee -a env_info.txt
          echo "OPENSSL_BIN=${OPENSSL_BIN}" >> "${GITHUB_ENV}"

      - name: Sanity check in container
        timeout-minutes: 2
        run: |
          echo "=== Sanity check: openssl/python ===" | tee -a env_info.txt
          echo "IMG=${IMG}" | tee -a env_info.txt
          echo "OPENSSL_BIN=${OPENSSL_BIN}" | tee -a env_info.txt

          docker run --rm "${IMG}" sh -lc "
            uname -a || true
            echo
            \"${OPENSSL_BIN}\" version -a || true
            echo
            \"${OPENSSL_BIN}\" list -providers || true
            echo
            \"${OPENSSL_BIN}\" list -groups 2>/dev/null | head -n 120 || true
          " 2>&1 | tee -a env_info.txt

          docker run --rm "${IMG}" sh -lc 'command -v python3 || true' 2>&1 | tee -a env_info.txt

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh

      - name: Environment info
        timeout-minutes: 2
        run: |
          IMG="${IMG}" OPENSSL_BIN="${OPENSSL_BIN}" bash scripts/env_info.sh 2>&1 | tee -a env_info.txt

      - name: TLS handshake throughput
        timeout-minutes: 3
        run: |
          IMG="${IMG}" OPENSSL_BIN="${OPENSSL_BIN}" TIMESEC="${TIMESEC}" \
            bash scripts/bench_tls.sh 2>&1 | tee -a tls_bench.txt

      - name: TLS handshake latency
        timeout-minutes: 3
        run: |
          IMG="${IMG}" OPENSSL_BIN="${OPENSSL_BIN}" N="${N}" \
            bash scripts/bench_tls_latency.sh 2>&1 | tee -a tls_latency.txt

      - name: Signature benchmark
        timeout-minutes: 3
        run: |
          IMG="${IMG}" OPENSSL_BIN="${OPENSSL_BIN}" BENCH_SECONDS="${BENCH_SECONDS}" \
            bash scripts/bench_sig.sh 2>&1 | tee -a sig_bench.txt

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pqc-bench-results
          path: |
            env_info.txt
            tls_bench.txt
            tls_latency.txt
            sig_bench.txt
